#!/usr/bin/env bash
set -u

# Pre-commit checks:
# 1) block when public methods exceed the limit
# 2) block when base templates exceed the limit (elements are exempt)
PUBLIC_LIMIT="${PRECOMMIT_PUBLIC_FUNCTION_MAX_LINES:-45}"
TEMPLATE_LIMIT="${PRECOMMIT_TEMPLATE_MAX_LINES:-45}"

if [ "${SOFT_PRECOMMIT_DISABLE:-0}" = "1" ]; then
  exit 0
fi

STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR)

if [ -z "$STAGED_FILES" ]; then
  exit 0
fi

STAGED_PHP_FILES=$(printf "%s\n" "$STAGED_FILES" | grep -E '\.php$' || true)
FUNCTION_WARNINGS=""
TEMPLATE_WARNINGS=""

if [ -n "$STAGED_PHP_FILES" ]; then
  while IFS= read -r file; do
    [ -f "$file" ] || continue

    RESULTS=$(awk -v file="$file" -v public_limit="$PUBLIC_LIMIT" '
    function count_char(s, c,   n, i, ch) {
      n = 0
      for (i = 1; i <= length(s); i++) {
        ch = substr(s, i, 1)
        if (ch == c) n++
      }
      return n
    }

    BEGIN {
      in_func = 0
      seen_open = 0
      depth = 0
      start = 0
      vis = ""
      name = ""
    }

    {
      line = $0

      if (!in_func) {
        # PHP defaults to public when no visibility is specified.
        if (line ~ /^[[:space:]]*([[:alpha:]_][[:alnum:]_]*[[:space:]]+)*function[[:space:]]+&?[[:space:]]*[[:alpha:]_][[:alnum:]_]*[[:space:]]*\(/) {
          if (line ~ /^[[:space:]]*([[:alpha:]_][[:alnum:]_]*[[:space:]]+)*private[[:space:]]+/) {
            next
          }
          if (line ~ /^[[:space:]]*([[:alpha:]_][[:alnum:]_]*[[:space:]]+)*protected[[:space:]]+/) {
            next
          }

          vis = "public"
          name = line
          sub(/^[[:space:]]*([[:alpha:]_][[:alnum:]_]*[[:space:]]+)*/, "", name)
          sub(/^function[[:space:]]+&?[[:space:]]*/, "", name)
          sub(/[[:space:]]*\(.*/, "", name)
          start = NR
          in_func = 1
          seen_open = 0
          depth = 0
        }
      }

      if (in_func) {
        opens = count_char(line, "{")
        closes = count_char(line, "}")

        if (!seen_open && opens > 0) {
          seen_open = 1
        }

        if (!seen_open && line ~ /;[[:space:]]*$/) {
          in_func = 0
          vis = ""
          name = ""
          next
        }

        depth += opens
        depth -= closes

        if (seen_open && depth == 0) {
          len = NR - start + 1
          limit = public_limit

          if (len > limit) {
            printf "%s:%d:%s:%s:%d:%d\n", file, start, vis, name, len, limit
          }

          in_func = 0
          vis = ""
          name = ""
        }
      }
    }
    ' "$file")
    AWK_STATUS=$?

    if [ "$AWK_STATUS" -ne 0 ]; then
      echo "[pre-commit] Internal checker error in $file."
      echo "Use git commit --no-verify only if you need to bypass right now."
      exit 1
    fi

    if [ -n "$RESULTS" ]; then
      FUNCTION_WARNINGS="$FUNCTION_WARNINGS$RESULTS
"
    fi
  done <<< "$STAGED_PHP_FILES"

  STAGED_TEMPLATE_FILES=$(printf "%s\n" "$STAGED_PHP_FILES" | grep -E '^sourceFiles/templates/' | grep -Ev '^sourceFiles/templates/(element|elements)/' || true)

  if [ -n "$STAGED_TEMPLATE_FILES" ]; then
    while IFS= read -r file; do
      [ -f "$file" ] || continue
      line_count=$(wc -l < "$file")
      line_count=$(echo "$line_count" | tr -d '[:space:]')

      if [ "$line_count" -gt "$TEMPLATE_LIMIT" ]; then
        TEMPLATE_WARNINGS="$TEMPLATE_WARNINGS$file:$line_count:$TEMPLATE_LIMIT\n"
      fi
    done <<< "$STAGED_TEMPLATE_FILES"
  fi
fi

if [ -n "$FUNCTION_WARNINGS" ] || [ -n "$TEMPLATE_WARNINGS" ]; then
  echo ""
  echo "[pre-commit] Size checks"

  if [ -n "$FUNCTION_WARNINGS" ]; then
    echo ""
    echo "Public functions should fit on one screen when practical."
    echo "Private functions are not limited by this hook."

    while IFS= read -r row; do
      [ -n "$row" ] || continue
      file=$(echo "$row" | cut -d: -f1)
      line=$(echo "$row" | cut -d: -f2)
      vis=$(echo "$row" | cut -d: -f3)
      name=$(echo "$row" | cut -d: -f4)
      len=$(echo "$row" | cut -d: -f5)
      limit=$(echo "$row" | cut -d: -f6)
      echo "- $file:$line $vis function '$name' is $len lines (limit: $limit)."
      echo "  Suggestion: keep public function orchestration-only; move detailed logic into private helper methods."
      echo "  Pattern: set class properties in private helpers and read them back in the public function."
    done <<< "$FUNCTION_WARNINGS"
  fi

  if [ -n "$TEMPLATE_WARNINGS" ]; then
    echo ""
    echo "Base templates should fit on one screen when practical."
    echo "Elements are not limited by this hook."

    while IFS= read -r row; do
      [ -n "$row" ] || continue
      file=$(echo "$row" | cut -d: -f1)
      len=$(echo "$row" | cut -d: -f2)
      limit=$(echo "$row" | cut -d: -f3)
      echo "- $file is $len lines (limit: $limit)."
      echo "  Suggestion: extract chunks into sourceFiles/templates/element/ files."
    done <<< "$TEMPLATE_WARNINGS"
  fi

  echo ""
  echo "Commit blocked by pre-commit size checks."
  echo "Override options:"
  echo "- One commit only: git commit --no-verify"
  echo "- Keep hooks but bypass this check: SOFT_PRECOMMIT_DISABLE=1 git commit -m \"...\""
  exit 1
fi

exit 0
