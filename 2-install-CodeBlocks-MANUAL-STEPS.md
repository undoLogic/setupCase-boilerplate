# The following are not yet automaated

8.1.2. In the application.php page (sourceFiles/src/Application.php) add this function AFTER the "public function middleware(Middl....": NOTE: Make sure you import the required classes after you paste

```php
protected function getAuthenticationService() : AuthenticationService {
  $authenticationService = new AuthenticationService([
      'unauthenticatedRedirect' => Router::url('/login'),
      'queryParam' => 'redirect',
  ]);
  $fields = [
      'username' => 'email',
      'password' => 'password',
  ];
  
  // Load identifiers, ensure we check email and password fields
  $authenticationService->loadIdentifier('Authentication.Password', [
      'fields' => $fields
  ]);
  
  // Load the authenticators, you want session first
  $authenticationService->loadAuthenticator('Authentication.Session');
  
  // Protect against Submit flooding
  //  $authenticationService->loadAuthenticator(FormLoginAttemptsAuthenticator::class, [
  //      'fields' => $fields,
  //      'loginUrl' => Router::url('/login'),
  //  ]);

  //Normal without flooding prevention
  $authenticationService->loadAuthenticator('Authentication.Form', [
      'fields' => $fields,
      'loginUrl' => Router::url('/login'),
  ]);
  
  // If the user is on the login page, check for a cookie as well.
  $authenticationService->loadAuthenticator('Authentication.Cookie', [
      'fields' => $fields,
      'loginUrl' => '/login',
      'cookie' => [
        'name' => 'remember_me_cookie',
        'expire' => strtotime('+30 days'), // Set the desired expiration time
        'httpOnly' => true,
      ],
  ]);
  
  return $authenticationService;
}
```

8.1.3. Now add to the same file Application.php add ABOVE the CSRF (sourceFiles\src\Application.php): NOTE: You will need to right click and import these classes after you paste


```php
//Added by SetupCase-BoilerPlate
->add(new EncryptedCookieMiddleware(
    ['CookieAuth'],
    'CHANGEMEWITHSECURE'
))
->add(new AuthenticationMiddleware($this->getAuthenticationService()))
->add(new LangMiddleware())
->add(new RbacMiddleware())
->add(new AccessMiddleware())
```


Ensure you import the required classes at the top of the file

```php
    use App\Authenticator\FormLoginAttemptsAuthenticator;
    use Cake\Http\Middleware\EncryptedCookieMiddleware;
```

8.1.4. AppController->initialize: ADD

```php
$this->loadComponent('Authentication.Authentication');
```


8.1.5. Add the SetupCase function to the AppController.php file:
NOTE: Don't forget to import the classes with right click (in PHPstorm) 8.1.6. In App_controller / beforeFilter

```php
public function beforeFilter(EventInterface $event) {
    parent::beforeFilter($event); // TODO: Change the autogenerated stub
    $this->setupCase();
}
function setupCase() {

    $setupCase = new SetupCase;
    $setupCase->requirePasswordExcept(['www.LIVESITE.com', 'LIVESITE.com'], $_SERVER, $this->request->getSession());
    $setupCase->requireSSLExcept([
        'localhost', //add other hosts which should NOT redict to SSL
    ], $this);

    //redirect older langs
//    $oldLangCheck = $this->request->getParam('language');
//    if ($oldLangCheck == 'eng') {
//        $this->redirect(['language' => 'en']);
//    } elseif ($oldLangCheck == 'fre') {
//        $this->redirect(['language' => 'fr']);
//    }

    //RBAC/Access middleware decides if they are allowed in - here we redirect if needed
    $access_granted = $this->request->getAttribute('access_granted');
    if (!$access_granted) {
        $this->Flash->error($this->request->getAttribute('access_msg'));
        $this->redirect($this->referer());
    } else {
        //We handle all RBAC from our RBAC middleware - disable the CakePHP authentication for all pages
        $this->Authentication->addUnauthenticatedActions([$this->request->getAttribute('params')['action']]);
    }
    $this->set('webroot', Router::url('/'));
}

```



8.1.7. Src / View Helpers
Open AppView.php - add into initalize()

```php
$this->loadHelper('Auth');
$this->loadHelper('Lang');
```



8.1.9. Add routes Add these to the function "$routes->scope('/', function (RouteBuilder $builder): void {"

```php
# in the function 
# $routes->scope('/', function (RouteBuilder $builder) {
# ADD
$builder->connect('/login', ['controller' => 'Users', 'action' => 'login']);
$builder->connect('/logout', ['controller' => 'Users', 'action' => 'logout']);
$builder->connect('/beginReset', ['controller' => 'Users', 'action' => 'beginReset']);
$builder->connect('/reset', ['controller' => 'Users', 'action' => 'reset']);
            
// language
$builder->connect('/{language}', ['controller' => 'Pages', 'action' => 'home'], ['language' => 'en|fr|es']) ;
$builder->connect('/{language}/{controller}/{action}/*', [], ['language' => 'en|fr|es']);
$builder->connect('/{language}/{controller}', ['action' => 'index'], ['language' => 'en|fr|es']);
        
//redirect for older langs
//$builder->connect('/eng', ['controller' => 'Pages', 'action' => 'home'], ['language' => 'en|fr|es']) ;
//$builder->connect('/fre', ['controller' => 'Pages', 'action' => 'home'], ['language' => 'en|fr|es']) ;
//$builder->connect('/eng/{controller}/{action}/*', ['language' => 'eng', 'controller' => 'Pages', 'action' => 'redirect'], ['language' => 'en|fr|es']);
//$builder->connect('/fre/{controller}/{action}/*', [], ['language' => 'en|fr|es']);
//$builder->connect('/eng/{controller}', ['action' => 'index'], ['language' => 'en|fr|es']);
//$builder->connect('/fre/{controller}', ['action' => 'index'], ['language' => 'en|fr|es']);
```

Add these BELOW the function

```php

### Then add below that function new functions for the different Usertypes / Prefixes
$routes->prefix('staff', function (RouteBuilder $routes) {

    //with the lang
    $routes->connect('/:language/:controller/:action/*', [])->setPatterns(['language' => 'en|fr|es']) ;

    $routes->fallbacks(DashedRoute::class);
});

$routes->prefix('admin', function (RouteBuilder $routes) {

    //with the lang
    $routes->connect('/:language/:controller/:action/*', [])->setPatterns(['language' => 'en|fr|es']) ;

    $routes->fallbacks(DashedRoute::class);
});
```

8.2 Databases and Credentials (optional)
We harness server based passwords / credentials / api keys, etc

The source files do NOT contain any secret information ensuring that even if your sourceFiles get leaked, no private connection info will be exposed

We will store all the private data in the server PHP.ini (GLOBAL) file.

Ensure you have 2 databases created for main and testing


```php
# app_setupcase.php
'Datasources' => [
    'default' => [
        'url' => filter_var(env('DATABASE_DEFAULT_URL', get_cfg_var('DATABASE.DEFAULT.URL')), FILTER_VALIDATE_URL),
    ],
    'test' => [
        'url' => filter_var(env('DATABASE_TEST_URL', get_cfg_var('DATABASE.TEST.URL')), FILTER_VALIDATE_URL),
    ],
],
This will first try to load the docker environment vars otherwise will load from the PHP.ini file on the server
# docker-compose.yml
environment:
  DATABASE_URL: mysql://root:undologic@db/LIVE_database
  DATABASE_TEST_URL: mysql://root:undologic@db/automation
# PHP.ini
BOILER.Datasources.default.url = mysql://boilerplate:123@localhost/undoweb_boilerplate_testing
BOILER.Datasources.test.url = mysql://boilerplate:123@localhost/undoweb_boilerplate_test
```

TROUBLESHOOTING ERROR: Class "App\Controller\SetupCase" not found (could also be Router, etc) FIX: You did not import the class SetupCase


8.3 Fix windows line endings
Ensure our windows line endings are corrected

```php
cd PROJECTFILE/docker
./2loginDockerContainer.bat
// you are now inside the docker container
./fix-windows-line-endings.sh
//Now you can run command line tests without issues
```



8.5 Integrate a professional visual layout to your project

```php
function beforeFilter() {
$this->set('baseLayout', Router::url('/').'modules'.DS.'layout'.DS);
}
```

Now in the layout file (/src/templates/newLayout.php)

Find and replace the following:

```php
FIND src=" REPLACEWITH src="<?= $baseLayout; ?>
FIND href=" REPLACEWITH href="<?= $baseLayout; ?>
```







